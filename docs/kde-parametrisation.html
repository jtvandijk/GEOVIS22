<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 KDE parametrisation | Analysis and visualisation of surname data</title>
  <meta name="description" content="Geovisualisation Spring School." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="3 KDE parametrisation | Analysis and visualisation of surname data" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jtvandijk.github.io/GEOG0014/" />
  
  <meta property="og:description" content="Geovisualisation Spring School." />
  <meta name="github-repo" content="jtvandijk/GEOVIS22" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 KDE parametrisation | Analysis and visualisation of surname data" />
  
  <meta name="twitter:description" content="Geovisualisation Spring School." />
  

<meta name="author" content="Created by Justin van Dijk" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="basic-visualisation.html"/>
<link rel="next" href="map-export.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>




<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href=""><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="part"><span><b>Welcome</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Getting started</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#background-readings"><i class="fa fa-check"></i>Background readings</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#session-format"><i class="fa fa-check"></i>Session format</a></li>
</ul></li>
<li class="part"><span><b>Section 1</b></span></li>
<li class="chapter" data-level="1" data-path="loading-data.html"><a href="loading-data.html"><i class="fa fa-check"></i><b>1</b> Loading data</a>
<ul>
<li class="chapter" data-level="1.1" data-path="loading-data.html"><a href="loading-data.html#qgis-installation"><i class="fa fa-check"></i><b>1.1</b> QGIS installation</a></li>
<li class="chapter" data-level="1.2" data-path="loading-data.html"><a href="loading-data.html#data-preparation"><i class="fa fa-check"></i><b>1.2</b> Data preparation</a></li>
<li class="chapter" data-level="1.3" data-path="loading-data.html"><a href="loading-data.html#adding-data"><i class="fa fa-check"></i><b>1.3</b> Adding data</a></li>
<li class="chapter" data-level="1.4" data-path="loading-data.html"><a href="loading-data.html#organising-our-layers"><i class="fa fa-check"></i><b>1.4</b> Organising our layers</a></li>
<li class="chapter" data-level="1.5" data-path="loading-data.html"><a href="loading-data.html#inspecting-data-in-excel"><i class="fa fa-check"></i><b>1.5</b> Inspecting data in Excel</a></li>
<li class="chapter" data-level="1.6" data-path="loading-data.html"><a href="loading-data.html#loading-point-data-into-qgis"><i class="fa fa-check"></i><b>1.6</b> Loading point data into QGIS</a></li>
<li class="chapter" data-level="1.7" data-path="loading-data.html"><a href="loading-data.html#task-s1"><i class="fa fa-check"></i><b>1.7</b> Tasks</a></li>
</ul></li>
<li class="part"><span><b>Section 2</b></span></li>
<li class="chapter" data-level="2" data-path="basic-visualisation.html"><a href="basic-visualisation.html"><i class="fa fa-check"></i><b>2</b> Basic visualisation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="basic-visualisation.html"><a href="basic-visualisation.html#changing-symbologoy"><i class="fa fa-check"></i><b>2.1</b> Changing symbologoy</a></li>
<li class="chapter" data-level="2.2" data-path="basic-visualisation.html"><a href="basic-visualisation.html#creating-a-heatmap"><i class="fa fa-check"></i><b>2.2</b> Creating a heatmap</a></li>
<li class="chapter" data-level="2.3" data-path="basic-visualisation.html"><a href="basic-visualisation.html#adding-a-basemap"><i class="fa fa-check"></i><b>2.3</b> Adding a basemap</a></li>
<li class="chapter" data-level="2.4" data-path="basic-visualisation.html"><a href="basic-visualisation.html#task-s2"><i class="fa fa-check"></i><b>2.4</b> Tasks</a></li>
</ul></li>
<li class="part"><span><b>Section 3</b></span></li>
<li class="chapter" data-level="3" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html"><i class="fa fa-check"></i><b>3</b> KDE parametrisation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html#kernel-density-estimation"><i class="fa fa-check"></i><b>3.1</b> Kernel Density Estimation</a></li>
<li class="chapter" data-level="3.2" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html#qgis-processing-toolbox"><i class="fa fa-check"></i><b>3.2</b> QGIS processing toolbox</a></li>
<li class="chapter" data-level="3.3" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html#displaying-kde-values"><i class="fa fa-check"></i><b>3.3</b> Displaying KDE values</a></li>
<li class="chapter" data-level="3.4" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html#extracting-kde-values"><i class="fa fa-check"></i><b>3.4</b> Extracting KDE values</a></li>
<li class="chapter" data-level="3.5" data-path="kde-parametrisation.html"><a href="kde-parametrisation.html#task-s3"><i class="fa fa-check"></i><b>3.5</b> Tasks</a></li>
</ul></li>
<li class="part"><span><b>Section 4</b></span></li>
<li class="chapter" data-level="4" data-path="map-export.html"><a href="map-export.html"><i class="fa fa-check"></i><b>4</b> Map export</a>
<ul>
<li class="chapter" data-level="4.1" data-path="map-export.html"><a href="map-export.html#kde-map"><i class="fa fa-check"></i><b>4.1</b> KDE map</a></li>
<li class="chapter" data-level="4.2" data-path="map-export.html"><a href="map-export.html#print-layout"><i class="fa fa-check"></i><b>4.2</b> Print layout</a></li>
<li class="chapter" data-level="4.3" data-path="map-export.html"><a href="map-export.html#task-s4"><i class="fa fa-check"></i><b>4.3</b> Tasks</a></li>
</ul></li>
<li class="part"><span><b>Wrapping up</b></span></li>
<li class="chapter" data-level="" data-path="final-considerations.html"><a href="final-considerations.html"><i class="fa fa-check"></i>Final considerations</a>
<ul>
<li class="chapter" data-level="" data-path="final-considerations.html"><a href="final-considerations.html#before-you-leave"><i class="fa fa-check"></i>Before you leave</a></li>
<li class="chapter" data-level="" data-path="final-considerations.html"><a href="final-considerations.html#further-resources"><i class="fa fa-check"></i>Further resources</a></li>
<li class="chapter" data-level="" data-path="final-considerations.html"><a href="final-considerations.html#further-questions"><i class="fa fa-check"></i>Further questions</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Analysis and visualisation of surname data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="kde-parametrisation" class="section level1" number="3">
<h1><span class="header-section-number">3</span> KDE parametrisation</h1>
<div id="kernel-density-estimation" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Kernel Density Estimation</h2>
<p>Where the <strong>heatmap</strong> symbology is a nice way to quickly visualise a set of point data, there is only few options to change the result. A more advanced way to analyse the density of a point process, is through something called <a href="https://en.wikipedia.org/wiki/Kernel_density_estimation">Kernel Density Estimation</a> (KDE). KDE is a statistical technique to generate a smooth continuous distribution between data points that represent the density of the underlying pattern.</p>
<div class="note">
<p><strong>Note</strong> <br />
The <strong>heatmap</strong> that we created through the <strong>Symbology</strong> tab is in actual fact created by an <em>on the fly</em> KDE calculation with a set of default parameters.</p>
</div>
<p>When executing a KDE, a surface is produced (for the connoisseurs: a <a href="https://desktop.arcgis.com/en/arcmap/latest/manage-data/raster-and-images/what-is-raster-data.htm">raster dataset</a>) that details the estimated distribution of our event point data over space. Each cell within the raster contains a value that is this estimated density at that location; when visualised in its entirety as the whole raster, we can quickly identify areas of high and low density, i.e. where are clusters are located in our data set. To create this surface, a KDE computes a localised density for small subsets of our study area using overlapping windows, called a kernel. A kernel defines the shape and size of the window and can also weight the points, using a defined kernel function. The simplest kernel function is a basic kernel where each point in the kernel window is assigned equal weight. When we use a different kernel type, we are looking to weight the points within our kernel differently:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:kernel-type"></span>
<img src="images/geovis/kerneltypes.png" alt="Kernel types and their distributions." width="650pt" />
<p class="caption">
Figure 3.1: Kernel types and their distributions.
</p>
</div>
<p>Each function will result in a slightly different estimation. <a href="https://nij.ojp.gov/sites/g/files/xyckuh171/files/media/document/CrimeStat%2520IV%2520Chapter%252010.pdf">Levine (2013)</a> summarises the differences between the kernels as follows:</p>
<blockquote>
<p>The normal distribution weighs all points in the study area, though near points are weighted more highly than distant points. The other four techniques use a circumscribed circle around the grid cell. The uniform distribution weighs all points within the circle equally. The quartic function weighs near points more than far points, but the fall off is gradual. The triangular function weighs near points more than far points within the circle, but the fall off is more rapid. Finally, the negative exponential weighs near points much more highly than far points within the circle and the decay is very rapid.</p>
</blockquote>
<p>The kernel density approach generates a grid of density values whose cell size is smaller than that of the kernel window. Each cell is assigned the density value computed for the kernel window centered on that cell. The size of this window is called the <strong>bandwidth</strong>. The resulting surface is created from these individually, locally calculated density values. Another way to think about it is as a smoothed histogram, but now created in two-dimensional space. The explanation by <em>Jake VanderPlas</em> in his <a href="https://jakevdp.github.io/PythonDataScienceHandbook/05.13-kernel-density-estimation.html">Python Data Science Handbook</a> explains this idea in much more detail and very clearly.</p>
<div class="note">
<p><strong>TL;DR</strong> <br />
A Kernel Density Estimation (KDE) is the method that underlies the idea of a heatmap: creating a smoothed surface of a set of discrete locations.</p>
</div>
</div>
<div id="qgis-processing-toolbox" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> QGIS processing toolbox</h2>
<p>Where we can use the <strong>heatmap</strong> symbology to create a quick-and-dirty KDE surface to visualise a set of points, QGIS also comes with a set of geospatial processing tools that can be used to execute a variety of spatial analyses. One of these processing tools is called <strong>Kernel Density Estimation</strong>. The difference between the <strong>heatmap</strong> and the geospatial processing tool is that the latter gives the option to finetune the parameters of the KDE as well as that it allows you to save the output as a separate data file. Let’s run a KDE on your <code>bearers_of_vandijk</code> layer, but this time using the <strong>Processing Toolbox</strong>:</p>
<ul>
<li>In the main menubar, click on the <strong>Toolbox</strong> button to open the <strong>Processing Toolbox</strong>:
<br /><br />
<img src="images/geovis/toolbox.png" width="40" style="display: block; margin: auto;" />
<br /><br /></li>
<li>In the search bar type: <em>Kernel Density Estimation</em>.</li>
<li>Double click on: <strong>Heatmap (Kernel Density Estimation)</strong>.</li>
</ul>
<div class="note">
<p><strong>Note</strong> <br />
If the <strong>Toolbox</strong> button is not visible it is likely that the <strong>Processing</strong> plugin is not properly activated. You can activate this as follows:</p>
<ul>
<li>Go to <strong>Plugins</strong> &gt; <strong>Manage and Install Plugins …</strong>.</li>
<li>Go to the <strong>Installed</strong> tab and type <em>processing</em> in the search box. Then tick the box in front of <strong>Processing</strong> off and on again to force reload the <strong>Toolbox</strong>. Click <strong>Close</strong>. <a href="https://jtvandijk.github.io/GEOVIS22/images/geovis/processing_plugin.png" target="_blank">[See screenshot]</a></li>
</ul>
</div>
<ul>
<li>In the <strong>Heatmap (Kernel Density Estimation)</strong> dialogue box, select <code>bearers_of_vandijk</code> as your <strong>Point Layer</strong>.</li>
<li>Change the <strong>Radius</strong> to <code>10</code>. Click on the <strong>unit</strong> dropdown menu button and make sure that it is set to <em>kilometers</em>.</li>
<li>In the <strong>Output raster size</strong> section, change the <strong>Rows</strong> to <code>500</code>, the value for <strong>Columns</strong> should update automatically to <code>310</code>.</li>
<li>Click on the three dots (<strong>…</strong>) next to the <strong>[Save to temporary file]</strong> box and click on <strong>Save to File …</strong> and navigate to your <em>working directory</em>. Create a new folder named <code>surname_kde</code> and save the output of this geoprocessing tool as <code>kde_vandijk_10km</code>.</li>
<li>Click <strong>Save</strong> and click <strong>Run</strong> to calculate the KDE. Click <strong>Close</strong>.</li>
</ul>
<p>The <strong>GIF</strong> below summarises these steps:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:kde-10"></span>
<img src="images/geovis/kde_10km.gif" alt="Calculating a KDE with a bandwidth of 10km for the bearers of *Van Dijk*. [[Enlarge image]](https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_10km.gif){target=&quot;_blank&quot;}" width="850pt" />
<p class="caption">
Figure 3.2: Calculating a KDE with a bandwidth of 10km for the bearers of <em>Van Dijk</em>. <a href="https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_10km.gif" target="_blank">[Enlarge image]</a>
</p>
</div>
<p>The result is a smoothed version of the spatial point locations that represent all bearers of the surname <code>Van Dijk</code>. To be fair: it does look a little bit as if we only changed the symbology. Let’s calculate another KDE, but this time we will use a larger bandwidth of <code>30</code> kilometres instead of the <code>10</code> kilometres we have used previously. The <strong>GIF</strong> below summarises these steps:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:kde-30"></span>
<img src="images/geovis/kde_30km.gif" alt="Calculating a KDE with a bandwidth of 30km for the bearers of *Van Dijk*. [[Enlarge image]](https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_30km.gif){target=&quot;_blank&quot;}" width="850pt" />
<p class="caption">
Figure 3.3: Calculating a KDE with a bandwidth of 30km for the bearers of <em>Van Dijk</em>. <a href="https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_30km.gif" target="_blank">[Enlarge image]</a>
</p>
</div>
<p>Although not exactly pretty, the KDE layers show an estimate of “how many bearers” of <em>Van Dijk</em> are expected in each of the individual grid cells of our layer. Currently, as can be seen in the <strong>Layers</strong> panel, for the <code>kde_vandijk_30km</code> the highest density is <code>28.2531</code>. This highest density seems to be concentrated in London - you can toggle the <code>gb_cities</code> layer to confirm.</p>
</div>
<div id="displaying-kde-values" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Displaying KDE values</h2>
<p>We now have calculated two KDEs, however, the quick heatmap we created earlier by changing the symbology of our point layer looked much better. Let’s do something about this by changing the symbology of our <code>kde_vandijk_30km</code> layer. We will also adjust the minimum visible density to only show the areas in which the bearers of <em>Van Dijk</em> are mostly concentrated.</p>
<ul>
<li>Switch off the visibility of the <code>kde_vandijk_10km</code> layer in the <strong>Layers</strong> panel by unticking the checkbox in front of the layer.</li>
<li>Right click on the <code>kde_vandijk_30km</code> layer in the <strong>Layers</strong> panel and click on <strong>Properties …</strong>. Here we can change the symbology of the layer.</li>
<li>Change the <strong>Color gradient</strong> to <em>White to black</em>.</li>
<li>Change the minimum and maximum value of this <strong>Color gradient</strong> to <code>5</code> and <code>28.2531</code>, respectively.</li>
<li>Use the <strong>Contrast enhancement</strong> dropdown menu to select the <em>Stretch and Clip to MinMax</em> option.</li>
<li>Click <strong>Apply</strong>. Click <strong>OK</strong>.</li>
</ul>
<p>We now have a much better visualisation with darker areas indicating higher densities of the bearers of <em>Van Dijk</em>. The <strong>GIF</strong> below summarises these steps:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:kde-vis"></span>
<img src="images/geovis/kde_vis.gif" alt="Changing the KDE visualisation parameters. [[Enlarge image]](https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_vis.gif){target=&quot;_blank&quot;}" width="850pt" />
<p class="caption">
Figure 3.4: Changing the KDE visualisation parameters. <a href="https://jtvandijk.github.io/GEOVIS22/images/geovis/kde_vis.gif" target="_blank">[Enlarge image]</a>
</p>
</div>
</div>
<div id="extracting-kde-values" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Extracting KDE values</h2>
<p>Instead of simply updating the KDE values that we are displaying, we can also extract the values of the KDE layer and save these as a separate layer. We can do this with something called the <strong>Raster calculator</strong>. This little tool allows us to only keep the values above a certain threshold. Let’s extract all raster cells where there is at least 5 bearers of <em>Van Dijk</em> expected; similar as to what we just did with your visualisation.</p>
<ul>
<li>In the <strong>Processing Toolbox</strong> search bar type: <em>Raster calculator</em>.</li>
<li>Double click on: <strong>Raster calculator</strong>.</li>
<li>In the <strong>Expression</strong> toolbox type: <code>"kde_vandijk_30km@1 / (kde_vandijk_30km@1 &gt; 5)"</code>. This is to ensure that the calculation will only return values of 5 and above.</li>
<li>Click on the three dots (<strong>…</strong>) next to the <strong>referecne layer(s) (used for automated extend, cellsize and CRS) [optional]</strong> box and tick the box in front of <em>kde_vandijk_30km [EPSG:277000]</em>. Click <strong>OK</strong>.</li>
<li>In the <strong>Output CRS [optional]</strong> dropdown menu, select <em>Project CRS: EPSG:27700 - OSGB 1936 / British National Grid</em>.</li>
<li>Click on the three dots (<strong>…</strong>) next to the <strong>[Save to temporary file]</strong> box and click on <strong>Save to File …</strong> and navigate to your <em>working directory</em>. Save the output in your<code>surname_kde</code> folder as <code>kde_vandijk_10km_5min</code>.</li>
<li>Click <strong>Run</strong>. Click <strong>Close</strong>.</li>
</ul>
<p>We have now created a full, separate, new layer, only containing the raster cells where there is at least 5 bearers of <em>Van Dijk</em> expected. The <strong>GIF</strong> below summarises these steps:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rast-calc"></span>
<img src="images/geovis/rast_calc.gif" alt="Extracting KDE values from our raster layer.  [[Enlarge image]](https://jtvandijk.github.io/GEOVIS22/images/geovis/rast_calc.gif){target=&quot;_blank&quot;}" width="850pt" />
<p class="caption">
Figure 3.5: Extracting KDE values from our raster layer. <a href="https://jtvandijk.github.io/GEOVIS22/images/geovis/rast_calc.gif" target="_blank">[Enlarge image]</a>
</p>
</div>
<ul>
<li>raster to vector to create area with at least n number of bearers</li>
</ul>
</div>
<div id="task-s3" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Tasks</h2>
<ul>
<li>different kernels</li>
<li>very small bandwidth</li>
<li>very large bandwidth</li>
<li>different grid size</li>
</ul>
<div class="note">
<p><strong>Note</strong> <br />
Error means no space &gt; probably grid is too large</p>
</div>
</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="basic-visualisation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="map-export.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jtvandijk/GEOVIS22/edit/master/index.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/jtvandijk/GEOVIS22/raw/master/index.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
